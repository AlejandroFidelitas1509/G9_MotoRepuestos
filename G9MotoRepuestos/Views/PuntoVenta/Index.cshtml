@model G9MotoRepuestos.Models.ViewModels.PuntoVentaVm
@{
    ViewData["Title"] = "Punto de Venta - Moto Repuestos Rojas";
    // INTERRUPTOR: Cambia a 'false' para ver la vista de Carrito/Cliente
    bool esVendedor = true;
}

@if (esVendedor)
{
    <div class="pos-admin-container fade-in">

        @* ALERTAS *@
        <div class="px-3 pt-3">
            @if (TempData["Ok"] != null)
            {
                <div class="alert alert-success mb-2">@TempData["Ok"]</div>
            }
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger mb-2">@TempData["Error"]</div>
            }
            @if (TempData["Warning"] != null)
            {
                <div class="alert alert-warning mb-2">@TempData["Warning"]</div>
            }
        </div>

        <div class="pos-shortcuts bg-dark text-white d-flex align-items-center px-3 py-2 justify-content-between">
            <div class="d-flex gap-4">
                <span><kbd class="bg-danger">F1</kbd> Buscar</span>
                <span><kbd class="bg-danger">F10</kbd> Cobrar</span>
            </div>
            <div class="text-danger fw-bold">PUNTO DE VENTA - MODO CAJERO</div>
        </div>

        <div class="row g-0 main-pos-height">
            <div class="col-md-1 pos-sidebar d-flex flex-column align-items-center py-4">
                <button class="pos-side-btn active" title="Ventas"><i class="fas fa-cash-register"></i></button>
                <button class="pos-side-btn" title="Inventario"><i class="fas fa-boxes"></i></button>
                <button class="pos-side-btn" title="Cierre"><i class="fas fa-calculator"></i></button>
            </div>

            <div class="col-md-8 bg-white p-4 d-flex flex-column">

                @* FORM agregar *@
                <div class="search-section mb-3">
                    <form asp-controller="PuntoVenta" asp-action="AddItem" method="post" class="input-group input-group-lg shadow-sm border rounded-3 overflow-hidden">
                        @Html.AntiForgeryToken()
                        <span class="input-group-text bg-light border-0"><i class="fas fa-barcode text-muted"></i></span>
                        <input type="text" name="query" id="CodigoBarras" class="form-control border-0 bg-light"
                               placeholder="Escanear Código de Barras o Nombre..." autocomplete="off">
                        <button class="btn btn-dark px-4 border-0" type="submit">Añadir</button>
                    </form>
                </div>

                <div class="table-responsive flex-grow-1 border rounded-4 bg-light shadow-inner">
                    <table class="table table-hover align-middle mb-0 bg-white">
                        <thead class="bg-dark text-white">
                            <tr>
                                <th>Cod.</th>
                                <th>Descripción</th>
                                <th class="text-center">Cant.</th>
                                <th class="text-end">Precio</th>
                                <th class="text-end">Total</th>
                                <th class="text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="listaVenta">

                            @if (Model.Carrito == null || !Model.Carrito.Any())
                            {
                                <tr class="border-bottom">
                                    <td colspan="6" class="text-center py-5 text-muted">
                                        No hay productos en el carrito.
                                    </td>
                                </tr>
                            }
                            else
                            {
                                foreach (var item in Model.Carrito)
                                {
                                    <tr class="border-bottom">
                                        <td class="fw-bold text-muted">@item.Codigo</td>
                                        <td>
                                            <div class="fw-bold text-dark">@item.Nombre</div>
                                            @if (item.Stock > 0)
                                            {
                                                <small class="text-muted">Stock: @item.Stock</small>
                                            }
                                            else
                                            {
                                                <small class="text-muted">Servicio</small>
                                            }
                                        </td>

                                        <td class="text-center" style="width: 170px;">
                                            <form asp-controller="PuntoVenta" asp-action="UpdateQty" method="post"
                                                  class="d-flex justify-content-center align-items-center gap-2">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@item.Id" />
                                                <input type="number" name="qty"
                                                       class="form-control form-control-sm text-center fw-bold border-2"
                                                       value="@item.Cantidad" min="1" style="width: 90px;">
                                                <button type="submit" class="btn btn-sm btn-outline-secondary">OK</button>
                                            </form>
                                        </td>

                                        <td class="text-end text-dark">₡ @item.Precio.ToString("N0")</td>
                                        <td class="text-end fw-bold text-dark">₡ @item.TotalLinea.ToString("N0")</td>

                                        <td class="text-center">
                                            <form asp-controller="PuntoVenta" asp-action="RemoveItem" method="post">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@item.Id" />
                                                <button type="submit" class="btn btn-link text-danger p-0" title="Quitar">
                                                    <i class="fas fa-times-circle"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="col-md-3 bg-light border-start p-4 d-flex flex-column">

                <div class="card border-0 shadow-sm mb-4 rounded-4 overflow-hidden">
                    <div class="card-body bg-white">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted small fw-bold">SUBTOTAL</span>
                            <span class="fw-bold text-dark" id="SubTotal">₡ @Model.Subtotal.ToString("N0")</span>
                        </div>
                        <div class="d-flex justify-content-between mb-0">
                            <span class="text-muted small fw-bold">IVA (13%)</span>
                            <span class="fw-bold text-dark" id="IVA">₡ @Model.Iva.ToString("N0")</span>
                        </div>
                    </div>
                </div>

                <div class="total-box-eleventa bg-danger text-white p-4 rounded-4 text-center shadow-lg mb-4">
                    <small class="text-uppercase fw-bold opacity-75">Total Factura</small>
                    <h1 class="fw-bolder mb-0" id="Total">₡ @Model.Total.ToString("N0")</h1>
                </div>

                <div class="payment-methods mb-4">
                    <label class="form-label small fw-bold text-uppercase text-secondary mb-3">Forma de Pago</label>
                    <div class="row g-2">
                        <div class="col-4">
                            <input type="radio" class="btn-check" name="metodoPago" id="efectivo" value="Efectivo" checked onchange="cambiarMetodoPago()">
                            <label class="btn btn-outline-danger w-100 py-3 rounded-3" for="efectivo">
                                <i class="fas fa-money-bill-wave d-block mb-1"></i><small>Efectivo</small>
                            </label>
                        </div>
                        <div class="col-4">
                            <input type="radio" class="btn-check" name="metodoPago" id="tarjeta" value="Tarjeta" onchange="cambiarMetodoPago()">
                            <label class="btn btn-outline-danger w-100 py-3 rounded-3" for="tarjeta">
                                <i class="fas fa-credit-card d-block mb-1"></i><small>Tarjeta</small>
                            </label>
                        </div>
                        <div class="col-4">
                            <input type="radio" class="btn-check" name="metodoPago" id="sinpe" value="SINPE" onchange="cambiarMetodoPago()">
                            <label class="btn btn-outline-danger w-100 py-3 rounded-3" for="sinpe">
                                <i class="fas fa-mobile-alt d-block mb-1"></i><small>SINPE</small>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="fieldEfectivo" class="mb-4">
                    <label class="form-label small fw-bold text-secondary">Monto Recibido</label>
                    <input type="number" class="form-control form-control-lg border-2 text-center fw-bold mb-3" id="montoRecibido" placeholder="0">
                    <div class="d-flex justify-content-between p-3 bg-white rounded-3 border">
                        <span class="fw-bold text-secondary">Vuelto</span>
                        <span class="fw-bolder text-danger" id="vueltoMonto">₡ 0</span>
                    </div>
                </div>

                <div class="mt-auto d-grid gap-2">
                    @* Cancelar (vaciar carrito) *@
                    <form asp-controller="PuntoVenta" asp-action="ClearCart" method="post">
                        @Html.AntiForgeryToken()
                        <button class="btn btn-outline-danger w-100 py-2 fw-bold rounded-3"
                                type="submit" @(Model.Carrito != null && Model.Carrito.Any() ? "" : "disabled")>
                            Cancelar operación
                        </button>
                    </form>

                    @* Finalizar (todavía no hace venta; lo hacemos en el siguiente punto) *@
                    <button class="btn btn-success btn-lg w-100 py-3 fw-bold shadow rounded-3"
                            @(Model.Carrito != null && Model.Carrito.Any() ? "" : "disabled")>
                        <i class="fas fa-cash-register me-2"></i>FINALIZAR (F10)
                    </button>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="container py-4 fade-in">
        <div class="row">
            <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="fw-bold text-dark">Tienda <span class="text-danger">Rojas</span></h3>
                    <div class="dropdown">
                        <button class="btn btn-outline-dark rounded-pill px-4 dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            Categorías
                        </button>
                        <ul class="dropdown-menu border-0 shadow">
                            <li><a class="dropdown-item" href="#">Motor</a></li>
                            <li><a class="dropdown-item" href="#">Accesorios</a></li>
                            <li><a class="dropdown-item" href="#">Aceites</a></li>
                        </ul>
                    </div>
                </div>

                <div class="row g-4">
                    @for (int i = 0; i < 6; i++)
                    {
                        <div class="col-md-4 col-sm-6">
                            <div class="card h-100 border-0 shadow-sm product-card-client overflow-hidden rounded-4">
                                <div class="bg-light p-5 text-center position-relative">
                                    <i class="fas fa-motorcycle fa-4x text-white opacity-50"></i>
                                </div>
                                <div class="card-body">
                                    <h6 class="fw-bold mb-1">Repuesto de Prueba #@i</h6>
                                    <p class="small text-muted mb-2">Marca: @(i % 2 == 0 ? "Honda" : "Yamaha")</p>
                                    <h5 class="text-danger fw-bold">₡ 15,000</h5>
                                    <button class="btn btn-danger btn-sm w-100 mt-2 rounded-pill shadow-sm">
                                        <i class="fas fa-cart-plus me-1"></i> Añadir al carrito
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-lg border-0 rounded-4 sticky-top" style="top: 20px;">
                    <div class="card-header bg-dark text-white py-3 border-0">
                        <h5 class="mb-0 fw-bold d-flex justify-content-between">
                            <span><i class="fas fa-shopping-cart text-danger me-2"></i>Mi Orden</span>
                            <span class="badge bg-danger rounded-pill">1</span>
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="cart-items-list mb-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-light p-2 rounded me-3"><i class="fas fa-box text-muted"></i></div>
                                <div class="flex-grow-1">
                                    <h6 class="small fw-bold mb-0">Aceite Motul 4T</h6>
                                    <small class="text-muted">1 x ₡ 8,500</small>
                                </div>
                                <button class="btn btn-sm text-danger"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="border-top pt-3">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <span class="fw-bold text-muted small uppercase">Total estimado</span>
                                <h3 class="fw-bolder text-danger mb-0">₡ 8,500</h3>
                            </div>
                            <button class="btn btn-danger w-100 py-3 fw-bold rounded-pill shadow-lg">
                                PROCEDER AL PAGO
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        // Mantiene tu funcionalidad de UI, pero el carrito ya viene del servidor.
        function cambiarMetodoPago() {
            const efectivo = document.getElementById("efectivo");
            const field = document.getElementById("fieldEfectivo");
            field.style.display = efectivo.checked ? "block" : "none";
        }

        // Vuelto en tiempo real (solo UI por ahora)
        document.addEventListener("DOMContentLoaded", () => {
            cambiarMetodoPago();

            const input = document.getElementById("montoRecibido");
            if (!input) return;

            input.addEventListener("input", () => {
                const totalText = document.getElementById("Total")?.innerText || "₡ 0";
                const total = parseInt(totalText.replace(/[^\d]/g, "")) || 0;
                const recibido = parseInt(input.value || "0") || 0;
                const vuelto = Math.max(0, recibido - total);
                document.getElementById("vueltoMonto").innerText = "₡ " + vuelto.toLocaleString("es-CR");
            });
        });
    </script>

    <script src="~/js/PuntoVenta.js" asp-append-version="true"></script>
}
